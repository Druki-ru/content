---
title: Руководство по обновлению Drupal 9 до Drupal 10
slug: wiki/10/upgrade-drupal-9-to-drupal-10
core: 10
metatags:
  title: 'Обновление с Drupal 9 до Drupal 10'
  description: 'Что нужно сделать чтобы подготовить Drupal 9 к обновлению до Drupal 10, а затем, обновить его.'
authors:
  - Niklan
---

<Aside type="warning" header="Материал не завершен">

[Drupal 10](../index.md) находится в разработке, его релиз запланирован на июнь 2022. Материал подготавливается заранее, поэтому некоторая информация может измениться, дополниться или удалиться.

</Aside>

В этом руководстве вы узнаете, как подготовить сайт, созданный на [Drupal 9](../../9/index.md), для обновления на [Drupal 10](../index.md), а затем обновить его.

## Введение

[Drupal 10.0.0](../../releases/10/10.0.x/10.0.0/index.md) является практически идентичной копией [Drupal 9.4.0](../../releases/9/9.4.x/9.4.0/index.md), за исключением того, что в Drupal 10 удалён весь код который объявлен устаревшим за время поддержки Drupal 9.

Замена вызовов устаревшего API на новый API — является основной задачей при обновлении. Если вы уделяли достаточное внимание коду в процессе поддержки сайта на Drupal 9, обновление должно быть максимально простым, как если бы вы обновлялись на новый минорный релиз Drupal 9.

Обновление Drupal 9 до Drupal 10 должно быть очень простым, но каждый проект собирается по-разному. Проблемы с конкретными сторонними модулями вы должны будете решать индивидуально, так как ситуации будут у всех разные.

Обновление можно свести к двум основным этапам:

- **Подготовка Drupal 9:** На данном этапе необходимо будет привести в порядок сайт на  Drupal 9.
- **Обновление до Drupal 10:** На этом этапе будет производиться обновление зависимостей.

В данном руководстве расписаны все этапы, для того чтобы подготовить и обновить свой проект с Drupal 9 до Drupal 10.

<Aside type="tip">

Некоторые этапы содержат несколько вариантов поиска и решения проблем, пользуйтесь тем, который вам кажется более подходящим для вас и вашего проекта!

</Aside>

## Подготовка проекта к обновлению

В данном разделе описаны этапы, которые помогут вам подготовить сайт на Drupal 9 к последующему обновлению на Drupal 10.

Прежде чем начать подготовку к обновлению, настоятельно **рекомендуется сделать резервную копию** проекта и базы данных. После каждого успешно пройденного этапа вы можете делать новую резервную копию, чтобы не повторять все предыдущие действия.

<Aside type="warning">

Подготавливайте сайт к обновлению на локальном сервере, или сервере для разработки.

</Aside>

### Проверка системных требований

Прежде чем начать что-то делать с сайтом, убедитесь что ваш текущий боевой сервер соответствует [системным требованиям Drupal 10](../system-requirements/index.md).

**Сводка:**

- Минимальная версия PHP увеличена до 8.0.2, а рекомендуемая до 8.1.0+.
- База данных должна поддерживать JSON тип данных.
- Если вы используете MySQL или Percona Server — минимальная версия 5.7.8.
- Если вы используете MariaDB — минимальная версия 10.3.7.
- Если вы используете PostgreSQL — минимальная версия 12.
- Если вы используете SQLite — минимальная версия 3.26.

<Aside type="tip">

Если вы не уверены, поддерживает ли ваша база данных JSON тип, вы можете открыть «Отчёт о состоянии» (`/admin/reports/status`) на Drupal 9. На данной странице будет проверка «Поддержка JSON базой данных», которая и сообщит вам текущее состояние.

</Aside>

### Обновление ядра Drupal 9

Перед обновлением вам потребуется актуальная версия Drupal 9. Минимальная версия, необходимая для обновления до Drupal 10 — [Drupal 9.3.0](../../releases/9/9.3.x/9.3.0/index.md) (`#3261486` в [Drupal 10.0.0](../../releases/10/10.0.x/10.0.0/index.md)).

Хоть Drupal и предоставляет возможность обновиться до Drupal 10, пропустив [Drupal 9.4.0](../../releases/9/9.4.x/9.4.0/index.md), настоятельно **не рекомендуется** так делать.

В Drupal 9.4.0 пометили часть API устаревшим, не обновившись до данной версии, вы узнаете об этом только когда ваш сайт упадёт с исключением на Drupal 10. Эти проблемы могут всплыть уже в ходе использования Drupal 10 на боевом сервере.

### Обновление сторонних модулей

Если вы не обновили модули попутно с ядром, вам необходим обновить все используемые сторонние модули до актуальных версий, как вы это обычно делаете. В новых версиях может быть реализована поддержка Drupal 10 или улучшена совместимость.

### Обновление собственных модулей

Если на вашем проекте есть собственные [модули](../modules/index.md), то вам необходимо убедиться что они в актуальном состоянии и совместимы с Drupal 10.

Прежде всего, вам необходимо обновить свойство модуля `core_version_requirement` в `*.info.yml` файле. На момент обновления он должен включать как Drupal 9, так и Drupal 10:

```yaml
core_version_requirement: ^9 || ^10
```

Если в вашем `*.info.yml` файле до сих пор есть свойство `core`, его необходимо удалить.

Затем нужно найти все вызовы [устаревшего API](../../../deprecation/index.md) и обновить код чтобы он использовал новый API.

Например, ваш модуль использует функцию `drupal_get_path()`, которая объявлена устаревшей в [Drupal 9.3.0](../../releases/9/9.3.x/9.3.0/index.md). Данная функция удалена в Drupal 10, это означает, что ваш код, который использует эту функцию, перестанет работать.

Для того чтобы узнать что нужно делать в такой ситуации, в Drupal всегда имеются комментарии. Для этого вы должны открыть исходный код `drupal_get_path()` и в нём будет доступна вся информация.

```php
/**
 * Returns the path to a system item (module, theme, etc.).
 *
 * @param $type
 *   The type of the item; one of 'core', 'profile', 'module', 'theme', or
 *   'theme_engine'.
 * @param $name
 *   The name of the item for which the path is requested. Ignored for
 *   $type 'core'.
 *
 * @return string
 *   The path to the requested item or an empty string if the item is not found.
 *
 * @deprecated in drupal:9.3.0 and is removed from drupal:10.0.0. Use
 *   \Drupal\Core\Extension\ExtensionPathResolver::getPath() instead.
 *
 * @see https://www.drupal.org/node/2940438
 * @see \Drupal\Core\Extension\ExtensionList::getPath()
 */
function drupal_get_path($type, $name) {
  @trigger_error('drupal_get_path() is deprecated in drupal:9.3.0 and is removed from drupal:10.0.0. Use \Drupal\Core\Extension\ExtensionPathResolver::getPath() instead. See https://www.drupal.org/node/2940438', E_USER_DEPRECATED);
  return dirname(drupal_get_filename($type, $name));
}
```

Из исходного кода функции становится ясно, что функция объявлена устаревшей в Drupal 9.3.0 и вместо неё необходимо использовать метод `ExtensionPathResolver::getPath()`. Для более детальной информации предоставлена ссылка с описанием этого изменения.

#### Поиск устаревшего кода при помощи PHPStorm

В текущем разделе вы узнаете как найти код, который использует устаревший API при помощи IDE PHPStorm.

Для поиска вызова устаревших API при помощи PHPStorm следуйте следующим этапам:

- Запустите `Code | Analyze Code | Run Inspection by name` или <kbd>SHIFT</kbd> + <kbd>SHIFT</kbd> и начните вводить «Run inspection by name», а затем нажмите <kbd>Enter</kbd>.
- В появившемся окне «Enter inspection name:» введите «Deprecated», он будет в разделе `PHP | General`, затем нажмите <kbd>Enter</kbd>.
- В открывшемся модальном окне в разделе «Inspection Scope» выберите «Custom Scope» и выберите нужный Scope содержащий только ваш собственный код.
- Запустите анализ нажав на «OK».

В появившихся результатах будут перечислены все файлы и места, где используется устаревший код.

![Пример результатов поиска устаревшего кода](https://i.imgur.com/3YDDVrw.png)

Ваша задача, чтобы результатов было 0!

#### Поиск устаревшего кода при помощи Upgrade Status

В текущем разделе вы узнаете как найти код, который использует устаревший API при помощи модуля [Upgrade Status](https://www.drupal.org/project/upgrade_status).

<Aside>

Вы должны обязательно устанавливать данный модуль при помощи [Composer](../../../composer/index.md): `composer require drupal/upgrade_status`.

</Aside>

После того как вы установили данный модуль и включили его, перейдите на страницу `Отчёты | Upgrade Status`. На данной странице нас интересует раздел «Сканировать». В данном разделе выберете все собственные модули, а затем нажмите «Scan selected» внизу страницы.

![Модули Upgrade Status для сканирования](https://i.imgur.com/dX0Cn4p.png)

Дождитесь окончания сканирования, после чего у вас этот же отчёт, но уже с информацией по вашим модулям. Все модули, которые содержат проблемы, будут добавлены в секцию «Fix manually».

![Модули с обнаруженными проблемами Upgrade Status](https://i.imgur.com/1NinqOb.png)

По каждому модулю будет предоставлена информация о найденных проблемах, вы можете нажать на ссылку «X problem(s)» чтобы получить больше информации.

![Пример найденных проблем для модуля при помощи Upgrade Status](https://i.imgur.com/H9eRpfQ.png)

В примере выше видно, что для модуля `druki_author` не указана поддержка Drupal 10 в `core_version_requirement` о которой писалось выше.

Вам необходимо устранить все проблемы, найденные модулем. После того как вы считате что устранили все проблемы, или хотите провести проверку повторно, выделите желаемые модули и запустите сканирование повторно.

Если вы исправите все проблемы, модули попадут в раздел «Compatible with next major Drupal core version» — это означает что эти модули не содержат код и прочие проблемы, которые сломаются на Drupal 10.

![Успешное исправление проблем в Upgrade Status](https://i.imgur.com/Fy1pMqY.png)
